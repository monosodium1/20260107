{% extends "base_admin.html" %}

{% block title %}采集管理 - Al智能政企瞭望舆情数据采集与分析系统{% endblock %}

{% block extra_css %}
        .tech-button {
            background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
            transition: all 0.3s ease;
        }
        .tech-button:hover {
            background: linear-gradient(135deg, #3b82f6 0%, #60a5fa 100%);
            box-shadow: 0 0 20px rgba(59, 130, 246, 0.6);
        }
        .tech-button:disabled {
            background: #4b5563;
            cursor: not-allowed;
        }
        .source-switch {
            position: relative;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .source-switch.active {
            border-color: #3b82f6;
            background-color: rgba(59, 130, 246, 0.2);
        }
        .source-switch input[type="checkbox"] {
            display: none;
        }
        .source-switch .checkmark {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 24px;
            height: 24px;
            background-color: #1e3a8a;
            border: 2px solid #3b82f6;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }
        .source-switch.active .checkmark {
            background-color: #3b82f6;
        }
        .source-switch .checkmark::after {
            content: '✓';
            color: white;
            font-size: 16px;
            font-weight: bold;
        }
        .data-card {
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .data-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(30, 64, 175, 0.4);
        }
        .data-card.selected {
            border-color: #10b981;
            box-shadow: 0 0 20px rgba(16, 185, 129, 0.6);
        }
        .data-card.selected::before {
            content: '✓';
            position: absolute;
            top: 8px;
            right: 8px;
            width: 24px;
            height: 24px;
            background-color: #10b981;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            z-index: 10;
        }
        .scroll-to-bottom {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 100;
            display: none;
        }
        .scroll-to-bottom.show {
            display: block;
        }
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .fade-in {
            animation: fadeIn 0.5s ease;
        }
        .loading-spinner {
            border: 3px solid #1e3a8a;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
{% endblock %}

{% block content %}
        <h1 class="text-3xl font-extrabold text-white mb-6 border-b border-blue-700 pb-3"> 采集管理 </h1>

        <div class="space-y-6">
            <div class="tech-panel p-6 rounded-xl">
                <h2 class="text-xl text-blue-300 mb-4 flex items-center">
                    <i class="fas fa-search mr-2"></i> 关键字输入
                </h2>
                <div class="flex gap-4">
                    <input type="text" id="keywordInput" placeholder="请输入搜索关键词..." 
                        class="flex-1 p-4 border border-gray-600 rounded-lg bg-gray-800 text-white text-lg focus:outline-none focus:border-blue-500">
                    <button id="startCollectionBtn" onclick="startCollection()" 
                        class="tech-button px-8 py-4 rounded-lg text-white font-semibold flex items-center">
                        <i class="fas fa-play mr-2"></i> 开始采集
                    </button>
                    <button id="stopCollectionBtn" onclick="stopCollection()" 
                        class="tech-button px-8 py-4 rounded-lg text-white font-semibold flex items-center hidden">
                        <i class="fas fa-stop mr-2"></i> 停止采集
                    </button>
                </div>
            </div>

            <div class="tech-panel p-6 rounded-xl">
                <h2 class="text-xl text-blue-300 mb-4 flex items-center">
                    <i class="fas fa-database mr-2"></i> 爬虫源选择
                </h2>
                <div id="sourceSwitches" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <div class="text-gray-400 col-span-full">加载中...</div>
                </div>
            </div>

            <div class="tech-panel p-6 rounded-xl">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl text-blue-300 flex items-center">
                        <i class="fas fa-list mr-2"></i> 采集数据
                        <span id="dataCount" class="ml-2 text-sm text-gray-400">(0条)</span>
                    </h2>
                    <div class="flex gap-2">
                        <button onclick="selectAll()" class="px-4 py-2 bg-gray-600 hover:bg-gray-700 rounded-lg text-white text-sm">
                            <i class="fas fa-check-double mr-1"></i> 全选
                        </button>
                        <button onclick="deselectAll()" class="px-4 py-2 bg-gray-600 hover:bg-gray-700 rounded-lg text-white text-sm">
                            <i class="fas fa-times mr-1"></i> 取消全选
                        </button>
                        <button onclick="saveSelected()" class="tech-button px-6 py-2 rounded-lg text-white text-sm">
                            <i class="fas fa-save mr-1"></i> 保存选中
                        </button>
                    </div>
                </div>

                <div id="collectionStatus" class="hidden mb-4 p-4 bg-blue-900 rounded-lg">
                    <div class="flex items-center">
                        <div class="loading-spinner mr-4"></div>
                        <div>
                            <p class="text-blue-300 font-semibold">正在采集数据...</p>
                            <p class="text-gray-400 text-sm">数据将实时显示在下方列表中</p>
                        </div>
                    </div>
                </div>

                <div id="dataGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
                    <div class="text-gray-400 col-span-full text-center py-12">
                        <i class="fas fa-inbox text-6xl mb-4 opacity-50"></i>
                        <p>暂无采集数据</p>
                        <p class="text-sm mt-2">输入关键词并选择爬虫源后开始采集</p>
                    </div>
                </div>
            </div>
        </div>

    <button id="scrollToBottom" onclick="scrollToBottom()" 
        class="scroll-to-bottom tech-button p-4 rounded-full shadow-lg">
        <i class="fas fa-arrow-down text-white text-xl"></i>
    </button>
{% endblock %}

{% block extra_js %}
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script>
        let collectedData = [];
        let selectedData = new Set();
        let eventSource = null;
        let isCollecting = false;

        $(document).ready(function() {
            loadSources();
        });

        function loadSources() {
            $.get('/api/collection/sources', function(data) {
                let html = '';
                if (data.sources.length === 0) {
                    html = '<div class="text-gray-400 col-span-full">暂无可用爬虫源，请先在爬虫管理中创建</div>';
                } else {
                    data.sources.forEach(function(source) {
                        html += `
                            <label class="source-tech-panel tech-panel p-4 rounded-lg source-switch" data-source-id="${source.id}">
                                <input type="checkbox" value="${source.id}" onchange="toggleSource(this)">
                                <div class="checkmark"></div>
                                <div class="flex items-center">
                                    <i class="fas fa-globe text-3xl text-blue-400 mr-4"></i>
                                    <div>
                                        <h3 class="font-semibold text-white">${source.name}</h3>
                                        <p class="text-sm text-gray-400">${source.source_type}</p>
                                    </div>
                                </div>
                            </label>
                        `;
                    });
                }
                $('#sourceSwitches').html(html);
            });
        }

        function toggleSource(checkbox) {
            const label = $(checkbox).closest('.source-switch');
            if (checkbox.checked) {
                label.addClass('active');
            } else {
                label.removeClass('active');
            }
        }

        function startCollection() {
            const keyword = $('#keywordInput').val().trim();
            if (!keyword) {
                alert('请输入搜索关键词');
                return;
            }

            const selectedSources = [];
            $('.source-switch input[type="checkbox"]:checked').each(function() {
                selectedSources.push(parseInt($(this).val()));
            });

            if (selectedSources.length === 0) {
                alert('请至少选择一个爬虫源');
                return;
            }

            isCollecting = true;
            collectedData = [];
            selectedData.clear();
            
            $('#startCollectionBtn').addClass('hidden');
            $('#stopCollectionBtn').removeClass('hidden');
            $('#collectionStatus').removeClass('hidden');
            $('#dataGrid').html('<div class="col-span-full text-center py-12"><div class="loading-spinner mx-auto mb-4"></div><p class="text-blue-300">正在初始化采集任务...</p></div>');

            $.post('/api/collection/start', {
                keyword: keyword,
                source_ids: JSON.stringify(selectedSources),
                page: 1,
                pages: 1,
                limit: 10
            }, function(response) {
                const collectionId = response.collection_id;
                startSSE(collectionId);
            }).fail(function() {
                alert('启动采集任务失败');
                stopCollection();
            });
        }

        function startSSE(collectionId) {
            eventSource = new EventSource(`/api/collection/stream?collection_id=${collectionId}`);

            eventSource.onmessage = function(event) {
                const data = JSON.parse(event.data);
                
                if (data.type === 'completed') {
                    stopCollection();
                    alert('采集完成！');
                    return;
                }

                if (data.type === 'error') {
                    stopCollection();
                    alert('采集出错: ' + data.error);
                    return;
                }

                if (data.error) {
                    console.error('Collection error:', data.error);
                    return;
                }

                addDataItem(data);
            };

            eventSource.onerror = function() {
                console.error('SSE error');
                stopCollection();
            };
        }

        function addDataItem(data) {
            collectedData.push(data);
            
            const cardHtml = `
                <div class="data-card tech-panel rounded-lg overflow-hidden relative fade-in" data-id="${collectedData.length - 1}" onclick="toggleSelect(${collectedData.length - 1})">
                    <div class="h-48 bg-gray-800 overflow-hidden">
                        <img src="${data.image_url || '/static/images/default-cover.svg'}" 
                            alt="${data.title}" 
                            class="w-full h-full object-cover"
                            onerror="this.src='/static/images/default-cover.svg'">
                    </div>
                    <div class="p-4">
                        <h3 class="font-semibold text-white mb-2 line-clamp-2" title="${data.title}">
                            <a href="${data.url}" target="_blank" class="hover:text-blue-400" onclick="event.stopPropagation()">
                                ${data.title}
                            </a>
                        </h3>
                        <div class="flex items-center text-sm text-gray-400 mb-2">
                            <i class="fas fa-clock mr-1"></i>
                            <span>${data.collected_at}</span>
                        </div>
                        <div class="flex items-center text-sm text-gray-400">
                            <i class="fas fa-globe mr-1"></i>
                            <span>${data.source_name || data.source}</span>
                        </div>
                    </div>
                </div>
            `;

            if ($('#dataGrid').find('.text-gray-400').length > 0) {
                $('#dataGrid').empty();
            }

            $('#dataGrid').append(cardHtml);
            $('#dataCount').text(`(${collectedData.length}条)`);

            scrollToBottom();
        }

        function toggleSelect(index) {
            const card = $(`.data-card[data-id="${index}"]`);
            if (selectedData.has(index)) {
                selectedData.delete(index);
                card.removeClass('selected');
            } else {
                selectedData.add(index);
                card.addClass('selected');
            }
        }

        function selectAll() {
            collectedData.forEach((_, index) => {
                selectedData.add(index);
                $(`.data-card[data-id="${index}"]`).addClass('selected');
            });
        }

        function deselectAll() {
            selectedData.clear();
            $('.data-card').removeClass('selected');
        }

        function saveSelected() {
            if (selectedData.size === 0) {
                alert('请先选择要保存的数据');
                return;
            }

            const itemsToSave = [];
            selectedData.forEach(index => {
                itemsToSave.push(collectedData[index]);
            });

            $.post('/api/collection/save', {
                data: JSON.stringify(itemsToSave)
            }, function(response) {
                alert(`成功保存 ${response.saved_count} 条数据`);
                deselectAll();
            }).fail(function() {
                alert('保存数据失败');
            });
        }

        function stopCollection() {
            isCollecting = false;
            
            if (eventSource) {
                eventSource.close();
                eventSource = null;
            }

            $('#startCollectionBtn').removeClass('hidden');
            $('#stopCollectionBtn').addClass('hidden');
            $('#collectionStatus').addClass('hidden');
        }

        function scrollToBottom() {
            $('html, body').animate({
                scrollTop: $(document).height()
            }, 300);
        }

        $(window).scroll(function() {
            const scrollPosition = $(window).scrollTop();
            const windowHeight = $(window).height();
            const documentHeight = $(document).height();

            if (documentHeight - scrollPosition - windowHeight > 500) {
                $('#scrollToBottom').addClass('show');
            } else {
                $('#scrollToBottom').removeClass('show');
            }
        });
    </script>
{% endblock %}
