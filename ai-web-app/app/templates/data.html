{% extends "base_admin.html" %}

{% block title %}æ•°æ®ç®¡ç† - Alæ™ºèƒ½æ”¿ä¼ç­æœ›èˆ†æƒ…æ•°æ®é‡‡é›†ä¸åˆ†æç³»ç»Ÿ{% endblock %}

{% block extra_css %}
        .tech-button {
            background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
            transition: all 0.3s ease;
        }
        .tech-button:hover {
            background: linear-gradient(135deg, #3b82f6 0%, #60a5fa 100%);
            box-shadow: 0 0 20px rgba(59, 130, 246, 0.6);
        }
        .data-checkbox {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        .action-btn {
            padding: 4px 8px;
            border-radius: 4px;
            transition: all 0.2s ease;
        }
        .action-btn:hover {
            transform: scale(1.1);
        }
        .pagination-btn {
            padding: 6px 12px;
            border-radius: 6px;
            transition: all 0.2s ease;
        }
        .pagination-btn:hover {
            background-color: #1e40af;
        }
        .pagination-btn.active {
            background-color: #3b82f6;
        }
        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
        }
        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .max-w-md {
            max-width: 600px;
        }
{% endblock %}

{% block content %}
        <h1 class="text-3xl font-extrabold text-white mb-6 border-b border-blue-700 pb-3"> æ•°æ®ç®¡ç† </h1>

        <div class="tech-panel p-6 rounded-xl mb-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl text-blue-300"> æ•°æ®æ£€ç´¢ä¸æŸ¥è¯¢ </h2>
                <div class="flex items-center space-x-4">
                    <span class="text-gray-400">æ€»æ•°æ®é‡: <span id="totalDataCount" class="text-blue-400 font-bold">0</span></span>
                </div>
            </div>

            <div class="mb-4">
                <div class="flex gap-4">
                    <div class="flex-1 relative">
                        <input type="text" id="searchInput" placeholder="æœç´¢æ ‡é¢˜ã€æ‘˜è¦ã€æ¥æºã€å…³é”®è¯..." 
                            class="w-full p-3 pl-10 border border-gray-600 rounded-lg bg-gray-800 text-white focus:outline-none focus:border-blue-500">
                        <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                    </div>
                    <button onclick="searchData()" class="tech-button px-6 py-3 rounded-lg text-white font-semibold">
                        <i class="fas fa-search mr-2"></i> æœç´¢
                    </button>
                    <button onclick="resetSearch()" class="px-6 py-3 rounded-lg bg-gray-600 hover:bg-gray-700 text-white font-semibold">
                        <i class="fas fa-redo mr-2"></i> é‡ç½®
                    </button>
                </div>
            </div>

            <div class="flex gap-3 pt-4 border-t border-blue-700">
                <button onclick="selectAll()" class="px-4 py-2 bg-gray-600 hover:bg-gray-700 rounded-lg text-white text-sm">
                    <i class="fas fa-check-double mr-1"></i> å…¨é€‰
                </button>
                <button onclick="deselectAll()" class="px-4 py-2 bg-gray-600 hover:bg-gray-700 rounded-lg text-white text-sm">
                    <i class="fas fa-times mr-1"></i> å–æ¶ˆå…¨é€‰
                </button>
                <div class="border-l border-blue-700 mx-2"></div>
                <button onclick="batchDelete()" class="px-4 py-2 bg-red-600 hover:bg-red-700 rounded-lg text-white text-sm">
                    <i class="fas fa-trash mr-1"></i> æ‰¹é‡åˆ é™¤
                </button>
                <button onclick="batchDeepCollect()" class="px-4 py-2 bg-orange-600 hover:bg-orange-700 rounded-lg text-white text-sm">
                    <i class="fas fa-search-dollar mr-1"></i> æ‰¹é‡AIæ·±åº¦é‡‡é›†
                </button>
            </div>
        </div>

        <div class="tech-panel p-6 rounded-xl">
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead>
                        <tr class="border-b border-blue-700">
                            <th class="text-left py-3 px-4 w-12">
                                <input type="checkbox" id="selectAllCheckbox" class="data-checkbox" onchange="toggleSelectAll()">
                            </th>
                            <th class="text-left py-3 px-4 text-gray-400">å°é¢</th>
                            <th class="text-left py-3 px-4 text-gray-400">æ ‡é¢˜</th>
                            <th class="text-left py-3 px-4 text-gray-400">æ¥æº</th>
                            <th class="text-left py-3 px-4 text-gray-400">å…³é”®è¯</th>
                            <th class="text-left py-3 px-4 text-gray-400">é‡‡é›†æ—¶é—´</th>
                            <th class="text-left py-3 px-4 text-gray-400">ä¿å­˜æ—¶é—´</th>
                            <th class="text-left py-3 px-4 text-gray-400 w-40">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="dataTable">
                        <tr>
                            <td colspan="8" class="text-center py-12 text-gray-400">
                                <i class="fas fa-spinner fa-spin text-3xl mb-4"></i>
                                <p>åŠ è½½ä¸­...</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="flex justify-between items-center mt-6 pt-4 border-t border-blue-700">
                <div class="text-gray-400 text-sm">
                    æ˜¾ç¤º <span id="showingStart">0</span> - <span id="showingEnd">0</span> æ¡ï¼Œå…± <span id="totalItems">0</span> æ¡
                </div>
                <div class="flex items-center space-x-2" id="pagination">
                </div>
            </div>
        </div>

    <div id="deepCollectModal" class="modal">
        <div class="tech-panel p-6 rounded-xl w-full max-w-md">
            <h3 class="text-xl text-blue-300 mb-4">AIæ·±åº¦é‡‡é›†</h3>
            <div class="mb-4">
                <label class="block text-sm font-medium mb-2 text-gray-300">é€‰æ‹©AIæ¨¡å‹</label>
                <select id="deepCollectModelSelect" class="w-full p-3 border border-gray-600 rounded-lg bg-gray-800 text-white focus:outline-none focus:border-blue-500">
                    <option value="">è¯·é€‰æ‹©AIæ¨¡å‹</option>
                </select>
            </div>
            <div class="mb-4">
                <p class="text-gray-400 text-sm">å·²é€‰æ‹© <span id="selectedDataCount" class="text-blue-400 font-bold">0</span> æ¡æ•°æ®è¿›è¡Œæ·±åº¦é‡‡é›†</p>
            </div>
            <input type="hidden" id="deepCollectDataIds">
            <div class="flex gap-4">
                <button onclick="closeDeepCollectModal()" class="flex-1 px-6 py-3 rounded-lg bg-gray-600 hover:bg-gray-700 text-white font-semibold">
                    å–æ¶ˆ
                </button>
                <button onclick="startDeepCollection()" class="flex-1 tech-button px-6 py-3 rounded-lg text-white font-semibold">
                    å¼€å§‹é‡‡é›†
                </button>
            </div>
        </div>
    </div>

    <div id="progressModal" class="modal">
        <div class="tech-panel p-6 rounded-xl w-full max-w-md">
            <h3 class="text-xl text-blue-300 mb-4">æ·±åº¦é‡‡é›†è¿›è¡Œä¸­</h3>
            <div class="mb-6">
                <div class="w-full bg-gray-700 rounded-full h-4 overflow-hidden mb-2">
                    <div id="progressBar" class="h-full bg-gradient-to-r from-blue-500 to-blue-600 transition-all duration-300" style="width: 0%"></div>
                </div>
                <div class="flex justify-between items-center text-sm">
                    <span id="progressText" class="text-gray-400">0/0 (0%)</span>
                    <span id="progressFailed" class="text-red-400">å¤±è´¥: 0</span>
                </div>
            </div>
            <div class="text-center text-gray-400 text-sm">
                <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                <p>æ­£åœ¨ä½¿ç”¨AIè¿›è¡Œæ·±åº¦é‡‡é›†ï¼Œè¯·ç¨å€™...</p>
            </div>
        </div>
    </div>

    <div id="reportModal" class="modal">
        <div class="tech-panel p-6 rounded-xl w-full max-w-md">
            <div id="reportContent">
            </div>
        </div>
    </div>
{% endblock %}

{% block extra_js %}
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script>
        let currentPage = 1;
        let perPage = 10;
        let searchQuery = '';
        let selectedData = new Set();
        let totalItems = 0;
        let totalPages = 0;

        $(document).ready(function() {
            loadData();
            loadStats();
        });

        function loadStats() {
            $.get('/api/data/stats', function(data) {
                $('#totalDataCount').text(data.total_count);
            });
        }

        function loadData() {
            $('#dataTable').html(`
                <tr>
                    <td colspan="7" class="text-center py-12 text-gray-400">
                        <i class="fas fa-spinner fa-spin text-3xl mb-4"></i>
                        <p>åŠ è½½ä¸­...</p>
                    </td>
                </tr>
            `);

            $.get('/api/data/list', {
                page: currentPage,
                per_page: perPage,
                search: searchQuery
            }, function(data) {
                totalItems = data.total;
                totalPages = data.pages;
                
                if (data.data.length === 0) {
                    $('#dataTable').html(`
                        <tr>
                            <td colspan="8" class="text-center py-12 text-gray-400">
                                <i class="fas fa-inbox text-6xl mb-4 opacity-50"></i>
                                <p>æš‚æ— æ•°æ®</p>
                            </td>
                        </tr>
                    `);
                } else {
                    let html = '';
                    data.data.forEach(function(item) {
                        const title = item.title || 'æ— æ ‡é¢˜';
                        const displayTitle = title.length > 100 ? title.substring(0, 100) + '...' : title;
                        const url = item.url || '#';
                        const source = item.source || '-';
                        const keyword = item.keyword || '-';
                        const imageUrl = item.image_url || '';
                        const collectedAt = item.collected_at || '-';
                        const savedAt = item.saved_at || '-';
                        
                        html += `
                            <tr class="border-b border-blue-800 hover:bg-blue-900/30 transition-colors">
                                <td class="py-3 px-4">
                                    <input type="checkbox" class="data-checkbox" value="${item.id}" onchange="toggleSelect(${item.id})">
                                </td>
                                <td class="py-3 px-4">
                                    ${imageUrl ? `<img src="${imageUrl}" alt="å°é¢" class="w-16 h-16 object-cover rounded-lg border border-blue-700" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%2264%22 height=%2264%22 viewBox=%220 0 64 64%22%3E%3Crect width=%2264%22 height=%2264%22 fill=%22%231e3a5f%22/%3E%3Ctext x=%2232%22 y=%2236%22 text-anchor=%22middle%22 fill=%22%236b7280%22 font-size=%2224%22%3EğŸ–¼ï¸%3C/text%3E%3C/svg%3E'">` : '<div class="w-16 h-16 bg-gray-700 rounded-lg flex items-center justify-center text-gray-500 text-2xl">ğŸ–¼ï¸</div>'}
                                </td>
                                <td class="py-3 px-4">
                                    <div class="max-w-md">
                                        <a href="${url}" target="_blank" class="text-blue-400 hover:text-blue-300 font-medium" title="${title}">
                                            ${displayTitle}
                                        </a>
                                    </div>
                                </td>
                                <td class="py-3 px-4 text-gray-300">${source}</td>
                                <td class="py-3 px-4 text-gray-300">${keyword}</td>
                                <td class="py-3 px-4 text-gray-300">
                                    <div class="flex items-center gap-2">
                                        ${collectedAt}
                                        ${item.has_deep_collected ? '<span class="px-2 py-1 bg-green-600 text-white text-xs rounded">å·²æ·±åº¦é‡‡é›†</span>' : ''}
                                    </div>
                                </td>
                                <td class="py-3 px-4 text-gray-300">${savedAt}</td>
                                <td class="py-3 px-4">
                                    <div class="flex gap-2">
                                        <button onclick="deleteData(${item.id})" class="action-btn bg-red-600 hover:bg-red-700 text-white text-xs" title="åˆ é™¤">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                        <button onclick="deepCollect(${item.id})" class="action-btn bg-orange-600 hover:bg-orange-700 text-white text-xs" title="AIæ·±åº¦é‡‡é›†">
                                            <i class="fas fa-search-dollar"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        `;
                    });
                    $('#dataTable').html(html);
                }

                updatePagination();
                updateShowingInfo();
            }).fail(function() {
                $('#dataTable').html(`
                    <tr>
                        <td colspan="7" class="text-center py-12 text-red-400">
                            <i class="fas fa-exclamation-triangle text-3xl mb-4"></i>
                            <p>åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•</p>
                        </td>
                    </tr>
                `);
            });
        }

        function updatePagination() {
            let html = '';
            
            html += `<button onclick="goToPage(1)" class="pagination-btn ${currentPage === 1 ? 'active' : 'bg-gray-700 text-white'}" ${currentPage === 1 ? 'disabled' : ''}>é¦–é¡µ</button>`;
            html += `<button onclick="goToPage(${currentPage - 1})" class="pagination-btn bg-gray-700 text-white" ${currentPage === 1 ? 'disabled' : ''}>ä¸Šä¸€é¡µ</button>`;
            
            let startPage = Math.max(1, currentPage - 2);
            let endPage = Math.min(totalPages, currentPage + 2);
            
            if (startPage > 1) {
                html += `<span class="px-2 text-gray-400">...</span>`;
            }
            
            for (let i = startPage; i <= endPage; i++) {
                html += `<button onclick="goToPage(${i})" class="pagination-btn ${i === currentPage ? 'active' : 'bg-gray-700 text-white'}">${i}</button>`;
            }
            
            if (endPage < totalPages) {
                html += `<span class="px-2 text-gray-400">...</span>`;
            }
            
            html += `<button onclick="goToPage(${currentPage + 1})" class="pagination-btn bg-gray-700 text-white" ${currentPage === totalPages ? 'disabled' : ''}>ä¸‹ä¸€é¡µ</button>`;
            html += `<button onclick="goToPage(${totalPages})" class="pagination-btn ${currentPage === totalPages ? 'active' : 'bg-gray-700 text-white'}" ${currentPage === totalPages ? 'disabled' : ''}>æœ«é¡µ</button>`;
            
            $('#pagination').html(html);
        }

        function updateShowingInfo() {
            let start = (currentPage - 1) * perPage + 1;
            let end = Math.min(currentPage * perPage, totalItems);
            $('#showingStart').text(start);
            $('#showingEnd').text(end);
            $('#totalItems').text(totalItems);
        }

        function goToPage(page) {
            if (page < 1 || page > totalPages || page === currentPage) {
                return;
            }
            currentPage = page;
            selectedData.clear();
            updateSelectAllCheckbox();
            loadData();
        }

        function searchData() {
            searchQuery = $('#searchInput').val().trim();
            currentPage = 1;
            selectedData.clear();
            updateSelectAllCheckbox();
            loadData();
        }

        function resetSearch() {
            $('#searchInput').val('');
            searchQuery = '';
            currentPage = 1;
            selectedData.clear();
            updateSelectAllCheckbox();
            loadData();
        }

        function toggleSelect(id) {
            if (selectedData.has(id)) {
                selectedData.delete(id);
            } else {
                selectedData.add(id);
            }
            updateSelectAllCheckbox();
        }

        function toggleSelectAll() {
            const checkbox = $('#selectAllCheckbox');
            if (checkbox.prop('checked')) {
                selectAll();
            } else {
                deselectAll();
            }
        }

        function selectAll() {
            $('.data-checkbox').each(function() {
                const id = $(this).val();
                if (id) {
                    selectedData.add(parseInt(id));
                    $(this).prop('checked', true);
                }
            });
            updateSelectAllCheckbox();
        }

        function deselectAll() {
            selectedData.clear();
            $('.data-checkbox').prop('checked', false);
            updateSelectAllCheckbox();
        }

        function updateSelectAllCheckbox() {
            const totalCheckboxes = $('.data-checkbox').length - 1;
            const checkedCount = $('.data-checkbox:checked').length;
            
            if (totalCheckboxes > 0 && checkedCount === totalCheckboxes) {
                $('#selectAllCheckbox').prop('checked', true);
            } else {
                $('#selectAllCheckbox').prop('checked', false);
            }
        }

        function deleteData(id) {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡æ•°æ®å—ï¼Ÿ')) {
                $.ajax({
                    url: '/api/data/' + id,
                    type: 'DELETE',
                    success: function(response) {
                        if (response.success) {
                            alert(response.message);
                            loadData();
                            loadStats();
                        } else {
                            alert(response.message);
                        }
                    },
                    error: function() {
                        alert('åˆ é™¤å¤±è´¥ï¼Œè¯·é‡è¯•');
                    }
                });
            }
        }

        function batchDelete() {
            if (selectedData.size === 0) {
                alert('è¯·å…ˆé€‰æ‹©è¦åˆ é™¤çš„æ•°æ®');
                return;
            }

            if (confirm(`ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ${selectedData.size} æ¡æ•°æ®å—ï¼Ÿ`)) {
                $.ajax({
                    url: '/api/data/batch-delete',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({
                        data_ids: Array.from(selectedData)
                    }),
                    success: function(response) {
                        if (response.success) {
                            alert(response.message);
                            selectedData.clear();
                            updateSelectAllCheckbox();
                            loadData();
                            loadStats();
                        } else {
                            alert(response.message);
                        }
                    },
                    error: function() {
                        alert('æ‰¹é‡åˆ é™¤å¤±è´¥ï¼Œè¯·é‡è¯•');
                    }
                });
            }
        }

        function deepCollect(id) {
            showDeepCollectModal([id]);
        }

        function batchDeepCollect() {
            if (selectedData.size === 0) {
                alert('è¯·å…ˆé€‰æ‹©è¦è¿›è¡Œæ·±åº¦é‡‡é›†çš„æ•°æ®');
                return;
            }

            showDeepCollectModal(Array.from(selectedData));
        }

        function showDeepCollectModal(dataIds) {
            $('#deepCollectModal').addClass('show');
            loadAIModels();
            $('#deepCollectDataIds').val(JSON.stringify(dataIds));
            $('#selectedDataCount').text(dataIds.length);
        }

        function closeDeepCollectModal() {
            $('#deepCollectModal').removeClass('show');
        }

        function loadAIModels() {
            console.log('æ­£åœ¨åŠ è½½AIæ¨¡å‹...');
            $.get('/api/ai-models', function(data) {
                console.log('AIæ¨¡å‹æ•°æ®:', data);
                
                if (!data || !data.models) {
                    console.error('AIæ¨¡å‹æ•°æ®æ ¼å¼é”™è¯¯:', data);
                    $('#deepCollectModelSelect').html('<option value="">æš‚æ— å¯ç”¨AIæ¨¡å‹</option>');
                    return;
                }
                
                let html = '';
                data.models.forEach(function(model) {
                    console.log('å¤„ç†æ¨¡å‹:', model);
                    if (model.status === 'active') {
                        const modelId = model.id || '';
                        const modelName = model.name || 'æœªå‘½åæ¨¡å‹';
                        html += `<option value="${modelId}">${modelName}</option>`;
                    }
                });
                
                if (html === '') {
                    html = '<option value="">æš‚æ— æ´»è·ƒçš„AIæ¨¡å‹</option>';
                }
                
                console.log('ç”Ÿæˆçš„HTML:', html);
                $('#deepCollectModelSelect').html(html);
            }).fail(function(xhr, status, error) {
                console.error('åŠ è½½AIæ¨¡å‹å¤±è´¥:', status, error);
                console.error('å“åº”å†…å®¹:', xhr.responseText);
                $('#deepCollectModelSelect').html('<option value="">åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•</option>');
            });
        }

        function startDeepCollection() {
            console.log('å¼€å§‹æ·±åº¦é‡‡é›†...');
            const dataIds = JSON.parse($('#deepCollectDataIds').val());
            const modelId = $('#deepCollectModelSelect').val();

            console.log('æ•°æ®IDs:', dataIds);
            console.log('é€‰æ‹©çš„æ¨¡å‹ID:', modelId);

            if (!modelId) {
                alert('è¯·é€‰æ‹©AIæ¨¡å‹');
                return;
            }

            $('#deepCollectModal').removeClass('show');
            showProgressModal();

            $.ajax({
                url: '/api/deep-collection/start',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    collection_data_ids: dataIds,
                    ai_model_id: parseInt(modelId)
                }),
                success: function(response) {
                    console.log('æ·±åº¦é‡‡é›†å¯åŠ¨å“åº”:', response);
                    
                    // æ£€æŸ¥å“åº”æ ¼å¼
                    if (response.task_id || response.status === 'started') {
                        const taskId = response.task_id;
                        console.log('ä»»åŠ¡ID:', taskId);
                        pollProgress(taskId);
                    } else {
                        console.error('å¯åŠ¨å¤±è´¥:', response.message || response);
                        alert(response.message || 'å¯åŠ¨æ·±åº¦é‡‡é›†å¤±è´¥');
                        closeProgressModal();
                    }
                },
                error: function(xhr, status, error) {
                    console.error('å¯åŠ¨æ·±åº¦é‡‡é›†è¯·æ±‚å¤±è´¥:', status, error);
                    console.error('å“åº”å†…å®¹:', xhr.responseText);
                    alert('å¯åŠ¨æ·±åº¦é‡‡é›†å¤±è´¥ï¼Œè¯·é‡è¯•');
                    closeProgressModal();
                }
            });
        }

        function pollProgress(taskId) {
            console.log('å¼€å§‹è½®è¯¢è¿›åº¦ï¼Œä»»åŠ¡ID:', taskId);
            const interval = setInterval(function() {
                $.get('/api/deep-collection/status/' + taskId, function(response) {
                    console.log('è¿›åº¦å“åº”:', response);
                    
                    if (response.success) {
                        const status = response.status;
                        console.log('çŠ¶æ€è¯¦æƒ…:', status);
                        updateProgress(status);

                        if (status.status === 'completed' || status.status === 'failed') {
                            clearInterval(interval);
                            showCompletionReport(status);
                        }
                    } else {
                        console.error('è¿›åº¦æŸ¥è¯¢å¤±è´¥:', response);
                    }
                }).fail(function(xhr, status, error) {
                    console.error('è¿›åº¦æŸ¥è¯¢è¯·æ±‚å¤±è´¥:', status, error);
                    console.error('å“åº”å†…å®¹:', xhr.responseText);
                });
            }, 2000);
        }

        function updateProgress(status) {
            console.log('æ›´æ–°è¿›åº¦ï¼Œæ¥æ”¶åˆ°çš„status:', status);
            
            // ç¡®ä¿statusæ˜¯å¯¹è±¡
            if (!status || typeof status !== 'object') {
                console.error('statuså‚æ•°æ— æ•ˆ:', status);
                return;
            }
            
            const total = status.total || 0;
            const completed = status.completed || 0;
            const failed = status.failed || 0;
            const percentage = total > 0 ? Math.round((completed / total) * 100) : 0;

            console.log('è¿›åº¦æ•°æ® - æ€»è®¡:', total, 'å®Œæˆ:', completed, 'å¤±è´¥:', failed, 'ç™¾åˆ†æ¯”:', percentage);

            $('#progressBar').css('width', percentage + '%');
            $('#progressText').text(`${completed}/${total} (${percentage}%)`);
            $('#progressFailed').text(`å¤±è´¥: ${failed}`);
        }

        function showProgressModal() {
            $('#progressModal').addClass('show');
            $('#progressBar').css('width', '0%');
            $('#progressText').text('0/0 (0%)');
            $('#progressFailed').text('å¤±è´¥: 0');
        }

        function closeProgressModal() {
            $('#progressModal').removeClass('show');
        }

        function showCompletionReport(status) {
            console.log('æ˜¾ç¤ºå®ŒæˆæŠ¥å‘Šï¼ŒçŠ¶æ€:', status);
            closeProgressModal();

            const isSuccess = status.status === 'completed';
            const completed = status.completed || 0;
            const failed = status.failed || 0;
            const total = status.total || 0;

            console.log('æŠ¥å‘Šæ•°æ® - æˆåŠŸ:', isSuccess, 'å®Œæˆ:', completed, 'å¤±è´¥:', failed, 'æ€»è®¡:', total);

            let html = `
                <div class="text-center mb-6">
                    <i class="fas ${isSuccess ? 'fa-check-circle text-green-500' : 'fa-times-circle text-red-500'} text-6xl mb-4"></i>
                    <h3 class="text-2xl font-bold ${isSuccess ? 'text-green-400' : 'text-red-400'} mb-2">
                        ${isSuccess ? 'æ·±åº¦é‡‡é›†å®Œæˆ' : 'æ·±åº¦é‡‡é›†å¤±è´¥'}
                    </h3>
                </div>
                <div class="space-y-4 mb-6">
                    <div class="flex justify-between items-center">
                        <span class="text-gray-400">æ€»æ•°æ®é‡</span>
                        <span class="text-white font-bold">${total}</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-400">æˆåŠŸé‡‡é›†</span>
                        <span class="text-green-400 font-bold">${completed}</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-400">å¤±è´¥</span>
                        <span class="text-red-400 font-bold">${failed}</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-400">æˆåŠŸç‡</span>
                        <span class="text-blue-400 font-bold">${total > 0 ? Math.round((completed / total) * 100) : 0}%</span>
                    </div>
                </div>
                <div class="flex gap-4">
                    <button onclick="closeReportModal(); loadData(); loadStats();" class="flex-1 tech-button py-3 rounded-lg text-white font-semibold">
                        ç¡®å®š
                    </button>
                    <button onclick="closeReportModal(); window.location.href='/deep-collection';" class="flex-1 px-6 py-3 rounded-lg bg-gray-600 hover:bg-gray-700 text-white font-semibold">
                        æŸ¥çœ‹è¯¦æƒ…
                    </button>
                </div>
            `;

            $('#reportContent').html(html);
            $('#reportModal').addClass('show');
        }

        function closeReportModal() {
            $('#reportModal').removeClass('show');
        }

        $('#searchInput').keypress(function(e) {
            if (e.which === 13) {
                searchData();
            }
        });
    </script>
{% endblock %}
